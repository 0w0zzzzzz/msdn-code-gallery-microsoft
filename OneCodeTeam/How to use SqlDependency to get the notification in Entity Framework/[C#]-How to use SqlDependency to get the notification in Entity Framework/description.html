<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=23E9A5CBC52062E31AE45157B970504B" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=779C1C1BECDB79910DE087040C45EE9E" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>How to use SqlDependency to get the notification in Entity Framework</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>How to use SqlDependency to get the notification in Entity Framework</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            ADO.NET, Data Access, Entity Framework, .NET Development
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Entity Frameowork, Sqldependency, automatically update
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Data
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">8/17/2016</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/How-to-use-SqlDependency-5c0da0b3">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<hr>
<div><a href="http://blogs.msdn.com/b/onecode" style="margin-top:3px"><img src="http://bit.ly/onecodesampletopbanner" alt="">
</a></div>
<h1>How to Automatically Update Data by Sqldependency in Entity Framework (CSEFAutoUpdate)</h1>
<h2>Introduction</h2>
<p class="MsoNormal">We can use the Sqldependency to get the notification when the data is changed in database, but EF doesn't have the same feature. In this sample, we will demonstrate how to automatically update by Sqldependency in Entity Framework.</p>
<p class="MsoNormal">In this sample, we will demonstrate two ways that use SqlDependency to get the change notification to auto update data:</p>
<p class="MsoNormal">1. Get the notification of changes immediately.</p>
<p class="MsoNormal">2. Get the notification of changes regularly.</p>
<h2>Building the Sample</h2>
<p class="MsoNormal">Before you run the sample, you need to finish the following step:</p>
<p class="MsoNormal">Step1. Modify the connection string in the App.config-&gt; &lt;configuration&gt;-&gt; &lt;connectionStrings&gt; to your SQL Server 2008 database instance.</p>
<h2>Running the Sample</h2>
<p class="MsoNormal">Press F5 to run the sample, the following is the result.</p>
<p class="MsoNormal"><span><img src="description/image.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal"><strong>1. Immediately Update </strong></p>
<p class="MsoNormal"><span>First, input the range of price to get the products, or you can directly click the
<strong><em>Get Data</em></strong> button to get all the products. </span></p>
<p class="MsoNormal"><span>&nbsp;</span><span> <img src="description/ba171f9c-c3be-4789-9adb-6138bd0e53a4image.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">Second, you can click the cell in DataGridView to select the product or just input the id in
<strong><em>Product Id</em></strong>, and then input the new price. After click the
<strong><em>Update</em></strong> button, the value in DataGridView will update.</p>
<p class="MsoNormal"><span><img src="description/37565d02-469c-43b5-a1a7-3e956c1e911aimage.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">At finally, you can click <strong><em>Stop</em></strong> button to stop the Update.</p>
<p class="MsoNormal"><strong>2. Regularly Update </strong></p>
<p class="MsoNormal">First, input the range of price to get the products and input the seconds to set the period of update.</p>
<p class="MsoNormal"><span><img src="description/e79073a5-0dad-4c56-918e-46ee884b481aimage.png" alt="" width="756" height="452" align="middle">
</span></p>
<p class="MsoNormal">Then you can input the new price and update. The value will be updated at the end of the period.</p>
<p class="MsoNormal"><span><img src="description/ef95544e-6bde-4fc7-ab17-22561c9ece19image.png" alt="" width="756" height="452" align="middle">
</span></p>
<h2>Using the Code</h2>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
0.<strong> Start/Stop the monitor</strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span>We need a global location, to start/stop the sql dependency monitor activity for each DbContext. In this sample, we make use of form &quot;On Load&quot; and &quot;Form Closed&quot; event to put the codes.</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void AutoUpdate_Load(object sender, EventArgs e)
{
	btnGetData.Enabled = CanRequestNotifications();

	CreateDatabaseIfNotExist();

	// start immediate notification register
	ImmediateNotificationRegister&lt;Product&gt;.StartMonitor(warehouse);
	RegularlyNotificationRegister&lt;Product&gt;.StartMonitor(warehouse);
}

private void AutoUpdate_FormClosed(object sender, FormClosedEventArgs e)
{
	// stop notification monitor
	ImmediateNotificationRegister&lt;Product&gt;.StopMonitor(warehouse);
	RegularlyNotificationRegister&lt;Product&gt;.StopMonitor(warehouse);
}
</pre>
<div class="preview">
<pre class="csharp"><span class="cs__keyword">private</span>&nbsp;<span class="cs__keyword">void</span>&nbsp;AutoUpdate_Load(<span class="cs__keyword">object</span>&nbsp;sender,&nbsp;EventArgs&nbsp;e)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;btnGetData.Enabled&nbsp;=&nbsp;CanRequestNotifications();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;CreateDatabaseIfNotExist();&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;start&nbsp;immediate&nbsp;notification&nbsp;register</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ImmediateNotificationRegister&lt;Product&gt;.StartMonitor(warehouse);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;RegularlyNotificationRegister&lt;Product&gt;.StartMonitor(warehouse);&nbsp;
}&nbsp;
&nbsp;
<span class="cs__keyword">private</span>&nbsp;<span class="cs__keyword">void</span>&nbsp;AutoUpdate_FormClosed(<span class="cs__keyword">object</span>&nbsp;sender,&nbsp;FormClosedEventArgs&nbsp;e)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;stop&nbsp;notification&nbsp;monitor</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ImmediateNotificationRegister&lt;Product&gt;.StopMonitor(warehouse);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;RegularlyNotificationRegister&lt;Product&gt;.StopMonitor(warehouse);&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode"></div>
<div class="endscriptcode">1. <strong>Get the ObjectQuery</strong></div>
</span>
<p></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
We need the connection string, command string and parameters to create the SqlDependency, so we need to get the ObjectQuery. If we use DbQuery to query, we first convert the DbQuery to ObjectQuery.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">public static ObjectQuery GetObjectQuery&lt;TEntity&gt;(DbContext context, IQueryable query)
&nbsp;&nbsp;&nbsp; where TEntity : class
{
&nbsp;&nbsp;&nbsp; if (query is ObjectQuery)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return query as ObjectQuery;


&nbsp;&nbsp;&nbsp; if (context == null)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;Paramter cannot be null&quot;, &quot;context&quot;);


&nbsp;&nbsp;&nbsp; // Use the DbContext to create the ObjectContext
&nbsp;&nbsp;&nbsp; ObjectContext objectContext = ((IObjectContextAdapter)context).ObjectContext;
&nbsp;&nbsp;&nbsp; // Use the DbSet to create the ObjectSet and get the appropriate provider.
&nbsp;&nbsp;&nbsp; IQueryable iqueryable = objectContext.CreateObjectSet&lt;TEntity&gt;() as IQueryable;
&nbsp;&nbsp;&nbsp; IQueryProvider provider = iqueryable.Provider;


&nbsp;&nbsp;&nbsp; // Use the provider and expression to create the ObjectQuery.
&nbsp;&nbsp;&nbsp; return provider.CreateQuery(query.Expression) as ObjectQuery;
}

</pre>
<pre id="codePreview" class="csharp">public static ObjectQuery GetObjectQuery&lt;TEntity&gt;(DbContext context, IQueryable query)
&nbsp;&nbsp;&nbsp; where TEntity : class
{
&nbsp;&nbsp;&nbsp; if (query is ObjectQuery)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return query as ObjectQuery;


&nbsp;&nbsp;&nbsp; if (context == null)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;Paramter cannot be null&quot;, &quot;context&quot;);


&nbsp;&nbsp;&nbsp; // Use the DbContext to create the ObjectContext
&nbsp;&nbsp;&nbsp; ObjectContext objectContext = ((IObjectContextAdapter)context).ObjectContext;
&nbsp;&nbsp;&nbsp; // Use the DbSet to create the ObjectSet and get the appropriate provider.
&nbsp;&nbsp;&nbsp; IQueryable iqueryable = objectContext.CreateObjectSet&lt;TEntity&gt;() as IQueryable;
&nbsp;&nbsp;&nbsp; IQueryProvider provider = iqueryable.Provider;


&nbsp;&nbsp;&nbsp; // Use the provider and expression to create the ObjectQuery.
&nbsp;&nbsp;&nbsp; return provider.CreateQuery(query.Expression) as ObjectQuery;
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
2. <strong>Immediately Update</strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Before start the SqlDependency, stop all the SqlDependency.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void BeginSqlDependency()
{
&nbsp;&nbsp;&nbsp; SqlDependency.Stop(QueryExtension.GetConnectionString(oquery));
&nbsp;&nbsp;&nbsp; SqlDependency.Start(QueryExtension.GetConnectionString(oquery));


&nbsp;&nbsp;&nbsp; RegisterSqlDependency();
}

</pre>
<pre id="codePreview" class="csharp">private void BeginSqlDependency()
{
&nbsp;&nbsp;&nbsp; SqlDependency.Stop(QueryExtension.GetConnectionString(oquery));
&nbsp;&nbsp;&nbsp; SqlDependency.Start(QueryExtension.GetConnectionString(oquery));


&nbsp;&nbsp;&nbsp; RegisterSqlDependency();
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Then register the SqlDependency.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void RegisterSqlDependency()
{
&nbsp;&nbsp;&nbsp; if (command == null || connection == null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;command and connection cannot be null&quot;);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; // a notification object associated with it.
&nbsp;&nbsp;&nbsp; command.Notification = null;


&nbsp;&nbsp;&nbsp; // Create and bind the SqlDependency object to the command object.
&nbsp;&nbsp;&nbsp; dependency = new SqlDependency(command);
&nbsp;&nbsp;&nbsp; dependency.OnChange &#43;= new OnChangeEventHandler(DependencyOnChange);


&nbsp;&nbsp;&nbsp; // After register SqlDependency, the SqlCommand must be executed, or we can't 
&nbsp;&nbsp;&nbsp;&nbsp;// get the notification.
&nbsp;&nbsp;&nbsp; RegisterSqlCommand();
}

</pre>
<pre id="codePreview" class="csharp">private void RegisterSqlDependency()
{
&nbsp;&nbsp;&nbsp; if (command == null || connection == null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;command and connection cannot be null&quot;);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; // a notification object associated with it.
&nbsp;&nbsp;&nbsp; command.Notification = null;


&nbsp;&nbsp;&nbsp; // Create and bind the SqlDependency object to the command object.
&nbsp;&nbsp;&nbsp; dependency = new SqlDependency(command);
&nbsp;&nbsp;&nbsp; dependency.OnChange &#43;= new OnChangeEventHandler(DependencyOnChange);


&nbsp;&nbsp;&nbsp; // After register SqlDependency, the SqlCommand must be executed, or we can't 
&nbsp;&nbsp;&nbsp;&nbsp;// get the notification.
&nbsp;&nbsp;&nbsp; RegisterSqlCommand();
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
When data was changed, the even handler will be fired.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void DependencyOnChange(object sender, SqlNotificationEventArgs e)
{
&nbsp;&nbsp;&nbsp; // Move the original SqlDependency event handler.
&nbsp;&nbsp;&nbsp; SqlDependency dependency =(SqlDependency)sender;
&nbsp;&nbsp;&nbsp; dependency.OnChange -= DependencyOnChange;


&nbsp;&nbsp;&nbsp; if (OnChanged != null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnChanged(this,null);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // We re-register the SqlDependency.
&nbsp;&nbsp;&nbsp; RegisterSqlDependency();
}

</pre>
<pre id="codePreview" class="csharp">private void DependencyOnChange(object sender, SqlNotificationEventArgs e)
{
&nbsp;&nbsp;&nbsp; // Move the original SqlDependency event handler.
&nbsp;&nbsp;&nbsp; SqlDependency dependency =(SqlDependency)sender;
&nbsp;&nbsp;&nbsp; dependency.OnChange -= DependencyOnChange;


&nbsp;&nbsp;&nbsp; if (OnChanged != null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnChanged(this,null);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // We re-register the SqlDependency.
&nbsp;&nbsp;&nbsp; RegisterSqlDependency();
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
3. <strong>Regularly Update </strong></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
When register the SqlDependency, we create a Threading.Timer and set the delegate, state,delay time, period, and then run it.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void RegisterSqlDependency()
{
&nbsp;&nbsp;&nbsp; if (connection == null || command == null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;command and connection cannot be null&quot;);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; // a notification object associated with it.
&nbsp;&nbsp;&nbsp; command.Notification = null;


&nbsp;&nbsp;&nbsp; // Create and bind the SqlDependency object
&nbsp;&nbsp;&nbsp; // to the command object.
&nbsp;&nbsp;&nbsp; dependency = new SqlDependency(command);
&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Id of sqldependency:{0}&quot;, dependency.Id);


&nbsp;&nbsp;&nbsp; RegisterSqlCommand();


&nbsp;&nbsp;&nbsp; timer = new Timer(CheckChange, null, 0, interval);
&nbsp;&nbsp;&nbsp; timer.Change(0, interval);
}

</pre>
<pre id="codePreview" class="csharp">private void RegisterSqlDependency()
{
&nbsp;&nbsp;&nbsp; if (connection == null || command == null)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentException(&quot;command and connection cannot be null&quot;);
&nbsp;&nbsp;&nbsp; }


&nbsp;&nbsp;&nbsp; // Make sure the command object does not already have
&nbsp;&nbsp;&nbsp; // a notification object associated with it.
&nbsp;&nbsp;&nbsp; command.Notification = null;


&nbsp;&nbsp;&nbsp; // Create and bind the SqlDependency object
&nbsp;&nbsp;&nbsp; // to the command object.
&nbsp;&nbsp;&nbsp; dependency = new SqlDependency(command);
&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Id of sqldependency:{0}&quot;, dependency.Id);


&nbsp;&nbsp;&nbsp; RegisterSqlCommand();


&nbsp;&nbsp;&nbsp; timer = new Timer(CheckChange, null, 0, interval);
&nbsp;&nbsp;&nbsp; timer.Change(0, interval);
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
Then at the end of period, the delegate will be fired.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">private void CheckChange(object state)
{
&nbsp;&nbsp;&nbsp; if (dependency!=null&amp;&amp;dependency.HasChanges)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (OnChanged != null)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnChanged(this, null);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp; }
}

</pre>
<pre id="codePreview" class="csharp">private void CheckChange(object state)
{
&nbsp;&nbsp;&nbsp; if (dependency!=null&amp;&amp;dependency.HasChanges)
&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (OnChanged != null)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnChanged(this, null);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
&nbsp;&nbsp;&nbsp; }
}

</pre>
</div>
</div>
<div class="endscriptcode">
<ul>
<li>For VB.NET version, visit&nbsp;<a href="https://code.msdn.microsoft.com/How-to-use-SqlDependency-5c0da0b3/https://code.msdn.microsoft.com/How-to-use-SqlDependency-f4b8eb43">https://code.msdn.microsoft.com/How-to-use-SqlDependency-5c0da0b3/https://code.msdn.microsoft.com/How-to-use-SqlDependency-f4b8eb43</a>&nbsp;
</li><li><a href="http://msdn.microsoft.com/query/dev11.query?appId=Dev11IDEF1&amp;l=EN-US&amp;k=k(<a class="libraryLink" href="https://msdn.microsoft.com/en-US/library/System.Data.SqlClient.SqlDependency.aspx"  title="Auto generated link to System.Data.SqlClient.SqlDependency">System.Data.SqlClient.SqlDependency</a>);k(TargetFrameworkMoniker-.NETFramework,Version%3Dv4.5);k(DevLang-csharp)&rd=true">SqlDependency Class</a>
</li><li><a href="http://msdn.microsoft.com/en-us/library/a52dhwx7.aspx">Using SqlDependency in a Windows Application</a>
</li><li><a href="http://msdn.microsoft.com/en-us/library/System.Threading.Timer.aspx">Timer Class</a>
</li></ul>
</div>
<p class="MsoNormal"><span class="MsoHyperlink"><br>
</span></p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/d8d3630a-6b12-4c82-bad7-865f491df936image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
